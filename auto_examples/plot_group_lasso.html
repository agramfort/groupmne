<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>Multi-subject joint source localization with multi-task models &#8212; groupmne 0.0.1dev documentation</title>
    <link rel="stylesheet" href="../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/gallery.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/language_data.js"></script>
    <script type="text/javascript" src="../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-3.3.7/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-sphinx.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="prev" title="Multi-subject MEG processing" href="plot_process_meg.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head><body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../index.html">
          groupmne</a>
        <span class="navbar-text navbar-version pull-left"><b>0.0.1dev</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="index.html">Examples</a></li>
                <li><a href="../api.html">API</a></li>
                <li><a href="https://github.com/hichamjanati/groupmne">GitHub</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><p class="caption"><span class="caption-text">Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api.html">API Documentation</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorial - Examples</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="index.html">General examples</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"><ul>
<li><a class="reference internal" href="#">Multi-subject joint source localization with multi-task models</a><ul>
<li><a class="reference internal" href="#download-and-process-meg-data">Download and process MEG data</a></li>
<li><a class="reference internal" href="#source-and-forward-modeling">Source and forward modeling</a></li>
</ul>
</li>
</ul>
</ul>
</li>
              
            
            
            
            
            
              <li class="hidden-sm">
<div id="sourcelink">
  <a href="../_sources/auto_examples/plot_group_lasso.rst.txt"
     rel="nofollow">Source</a>
</div></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-12 content">
      
  <div class="sphx-glr-download-link-note admonition note">
<p class="admonition-title">Note</p>
<p>Click <a class="reference internal" href="#sphx-glr-download-auto-examples-plot-group-lasso-py"><span class="std std-ref">here</span></a> to download the full example code</p>
</div>
<div class="sphx-glr-example-title section" id="multi-subject-joint-source-localization-with-multi-task-models">
<span id="sphx-glr-auto-examples-plot-group-lasso-py"></span><h1>Multi-subject joint source localization with multi-task models<a class="headerlink" href="#multi-subject-joint-source-localization-with-multi-task-models" title="Permalink to this headline">¶</a></h1>
<p>The aim of this tutorial is to show how to leverage functional similarity
across subjects to improve source localization. For that purpose we use the
the high frequency SEF MEG dataset of (Nurminen et al., 2017) which provides
MEG and MRI data for two subjects.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Author: Hicham Janati (hicham.janati@inria.fr)</span>
<span class="c1">#</span>
<span class="c1"># License: BSD (3-clause)</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">os.path</span> <span class="k">as</span> <span class="nn">op</span>
<span class="kn">import</span> <span class="nn">mne</span>
<span class="kn">from</span> <span class="nn">mne.datasets</span> <span class="k">import</span> <span class="n">hf_sef</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="k">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="kn">from</span> <span class="nn">groupmne</span> <span class="k">import</span> <span class="n">group_model</span>
<span class="kn">from</span> <span class="nn">groupmne.inverse</span> <span class="k">import</span> <span class="n">compute_group_inverse</span>
</pre></div>
</div>
<div class="section" id="download-and-process-meg-data">
<h2>Download and process MEG data<a class="headerlink" href="#download-and-process-meg-data" title="Permalink to this headline">¶</a></h2>
<p>Averaged MEG data (and MRI) are provided in “evoked”.
We assume that the noise covariance matrices have been computed
using the raw data as shown in example plot_process_meg.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">data_path</span> <span class="o">=</span> <span class="n">hf_sef</span><span class="o">.</span><span class="n">data_path</span><span class="p">(</span><span class="s2">&quot;evoked&quot;</span><span class="p">)</span>
<span class="n">meg_path</span> <span class="o">=</span> <span class="n">data_path</span> <span class="o">+</span> <span class="s2">&quot;/MEG/&quot;</span>

<span class="n">data_path</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">data_path</span><span class="p">)</span>
<span class="n">subjects_dir</span> <span class="o">=</span> <span class="n">data_path</span> <span class="o">+</span> <span class="s2">&quot;/subjects/&quot;</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;SUBJECTS_DIR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">subjects_dir</span>

<span class="n">ev_name_s</span> <span class="o">=</span> <span class="p">[</span><span class="n">meg_path</span> <span class="o">+</span> <span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;subject_a/sef_right-ave.fif&quot;</span><span class="p">,</span>
             <span class="s2">&quot;subject_b/hf_sef_15min-ave.fif&quot;</span><span class="p">]]</span>
<span class="n">cov_name_s</span> <span class="o">=</span> <span class="p">[</span><span class="n">meg_path</span> <span class="o">+</span> <span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;subject_a/sef-cov.fif&quot;</span><span class="p">,</span>
              <span class="s2">&quot;subject_b/sef-cov.fif&quot;</span><span class="p">]]</span>

<span class="n">evoked_s</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">f</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <a href="https://matplotlib.org/api/_as_gen/matplotlib.pyplot.subplots.html#matplotlib.pyplot.subplots" title="View documentation for matplotlib.pyplot.subplots"><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span></a><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">ev_name</span><span class="p">,</span> <span class="n">ll</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axes</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">ev_name_s</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">]):</span>
    <span class="n">ev</span> <span class="o">=</span> <span class="n">mne</span><span class="o">.</span><span class="n">read_evokeds</span><span class="p">(</span><span class="n">ev_name</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">evoked_s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ev</span><span class="p">)</span>
    <span class="n">picks</span> <span class="o">=</span> <span class="n">mne</span><span class="o">.</span><span class="n">pick_types</span><span class="p">(</span><span class="n">ev</span><span class="o">.</span><span class="n">info</span><span class="p">,</span> <span class="n">meg</span><span class="o">=</span><span class="s2">&quot;grad&quot;</span><span class="p">)</span>
    <span class="n">ev</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">picks</span><span class="o">=</span><span class="n">picks</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Subject </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">ll</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<a href="https://matplotlib.org/api/_as_gen/matplotlib.pyplot.show.html#matplotlib.pyplot.show" title="View documentation for matplotlib.pyplot.show"><span class="n">plt</span><span class="o">.</span><span class="n">show</span></a><span class="p">()</span>
</pre></div>
</div>
<img alt="../_images/sphx_glr_plot_group_lasso_001.png" class="sphx-glr-single-img" src="../_images/sphx_glr_plot_group_lasso_001.png" />
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>Reading /Users/hichamjanati/mne_data/HF_SEF/MEG/subject_a/sef_right-ave.fif ...
    Found the data of interest:
        t =     -50.00 ...     300.00 ms (Category # 1)
        0 CTF compensation matrices available
        nave = 2514 - aspect type = 100
No projector specified for this dataset. Please consider the method self.add_proj.
No baseline correction applied
Reading /Users/hichamjanati/mne_data/HF_SEF/MEG/subject_b/hf_sef_15min-ave.fif ...
    Found the data of interest:
        t =     -50.00 ...     250.00 ms (SEF)
        0 CTF compensation matrices available
        nave = 2790 - aspect type = 100
No projector specified for this dataset. Please consider the method self.add_proj.
No baseline correction applied
</pre></div>
</div>
</div>
<div class="section" id="source-and-forward-modeling">
<h2>Source and forward modeling<a class="headerlink" href="#source-and-forward-modeling" title="Permalink to this headline">¶</a></h2>
<p>To guarantee an alignment across subjects, we start by
computing (or reading if available) the source space of the average
subject of freesurfer <cite>fsaverage</cite>
If fsaverage is not available, it will be fetched to the data_path</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># resolution = 3</span>
<span class="c1"># spacing = &quot;ico%d&quot; % resolution</span>
<span class="c1"># src_ref = group_model.get_src_reference(spacing=spacing,</span>
<span class="c1">#                                         subjects_dir=subjects_dir)</span>
<span class="c1">#</span>
<span class="c1"># ###################################################################</span>
<span class="c1">#</span>
<span class="c1"># # the function group_model.compute_fwd morphs the source space src_ref to</span>
<span class="c1"># # the surface of each subject by mapping the sulci and gyri patterns</span>
<span class="c1"># # and computes their forward operators</span>
<span class="c1">#</span>
<span class="c1"># subjects = [&quot;subject_a&quot;, &quot;subject_b&quot;]</span>
<span class="c1"># trans_fname_s = [meg_path + &quot;%s/sef-trans.fif&quot; % s for s in subjects]</span>
<span class="c1"># bem_fname_s = [subjects_dir + &quot;%s/bem/%s-5120-bem-sol.fif&quot; % (s, s)</span>
<span class="c1">#                for s in subjects]</span>
<span class="c1"># # n_jobs = 2</span>
<span class="c1"># # parallel, run_func, _ = parallel_func(group_model.compute_fwd,</span>
<span class="c1"># #                                       n_jobs=n_jobs)</span>
<span class="c1"># #</span>
<span class="c1"># # fwds = parallel(run_func(s, src_ref, info, trans, bem,  mindist=3)</span>
<span class="c1"># #                 for s, info, trans, bem in zip(subjects, raw_name_s,</span>
<span class="c1"># #                                                trans_fname_s, bem_fname_s))</span>
<span class="c1">#</span>
<span class="c1"># fwds = []</span>
<span class="c1"># noise_cov_s = []</span>
<span class="c1"># for s, info, trans, bem, cov_name in zip(subjects, ev_name_s,</span>
<span class="c1">#                                          trans_fname_s, bem_fname_s,</span>
<span class="c1">#                                          cov_name_s):</span>
<span class="c1">#     fwd = group_model.compute_fwd(s, src_ref, info, trans, bem,  mindist=3)</span>
<span class="c1">#     fwds.append(fwd)</span>
<span class="c1">#     cov = mne.read_cov(cov_name)</span>
<span class="c1">#     noise_cov_s.append(cov)</span>
<span class="c1">#     del fwd, cov</span>
<span class="c1">#</span>
<span class="c1"># ############################################</span>
<span class="c1"># # We can now compute the data of the inverse problem.</span>
<span class="c1"># # `group_info` is a dictionary that contains the selected channels and the</span>
<span class="c1"># # alignment maps between src_ref and the subjects which are required if you</span>
<span class="c1"># # want to plot source estimates on the brain surface of each subject.</span>
<span class="c1">#</span>
<span class="c1"># gains, M, group_info = \</span>
<span class="c1">#     group_model.compute_inv_data(fwds, src_ref, evoked_s, noise_cov_s,</span>
<span class="c1">#                                  ch_type=&quot;grad&quot;, tmin=0.02, tmax=0.04)</span>
<span class="c1"># print(&quot;(# subjects, # channels, # sources) = &quot;, gains.shape)</span>
<span class="c1"># print(&quot;(# subjects, # channels, # time points) = &quot;, M.shape)</span>
<span class="c1">#</span>
<span class="c1"># ############################################</span>
<span class="c1"># # Solve the inverse problems</span>
<span class="c1"># # --------------------------</span>
<span class="c1"># #</span>
<span class="c1"># stcs, log = compute_group_inverse(gains, M, group_info,</span>
<span class="c1">#                                   method=&quot;grouplasso&quot;,</span>
<span class="c1">#                                   depth=0.9, alpha=0.1, return_stc=True,</span>
<span class="c1">#                                   n_jobs=4)</span>
<span class="c1"># t = 0.025</span>
<span class="c1"># t_idx = stcs[0].time_as_index(t)</span>
<span class="c1"># for stc, subject in zip(stcs, subjects):</span>
<span class="c1">#     m = abs(stc.data[:group_info[&quot;n_sources&quot;][0], t_idx]).max()</span>
<span class="c1">#     surfer_kwargs = dict(</span>
<span class="c1">#         clim=dict(kind=&#39;value&#39;, pos_lims=[0., 0.1 * m, m]),</span>
<span class="c1">#         hemi=&#39;lh&#39;, subjects_dir=subjects_dir, views=&#39;lateral&#39;,</span>
<span class="c1">#         initial_time=t, time_unit=&#39;s&#39;, size=(800, 800),</span>
<span class="c1">#         smoothing_steps=5)</span>
<span class="c1">#     brain = stc.plot(**surfer_kwargs)</span>
<span class="c1">#     brain.add_text(0.1, 0.9, subject, &quot;title&quot;)</span>
</pre></div>
</div>
<p class="sphx-glr-timing"><strong>Total running time of the script:</strong> ( 0 minutes  2.903 seconds)</p>
<p><strong>Estimated memory usage:</strong>  70 MB</p>
<div class="sphx-glr-footer class sphx-glr-footer-example docutils container" id="sphx-glr-download-auto-examples-plot-group-lasso-py">
<div class="sphx-glr-download docutils container">
<p><a class="reference download internal" download="" href="../_downloads/e66cf913a6355c593439c84a85c97b44/plot_group_lasso.py"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">plot_group_lasso.py</span></code></a></p>
</div>
<div class="sphx-glr-download docutils container">
<p><a class="reference download internal" download="" href="../_downloads/b0faeeb80012e2669dc581382557e1b6/plot_group_lasso.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">plot_group_lasso.ipynb</span></code></a></p>
</div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.readthedocs.io">Gallery generated by Sphinx-Gallery</a></p>
</div>
</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2019, Hicham Janati.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.1.2.<br/>
    </p>
  </div>
</footer>
  </body>
</html>